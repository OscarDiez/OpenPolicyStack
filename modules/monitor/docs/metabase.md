# Metabase Dashboard ("Frontend")


## Setup 

[Metabase](https://www.metabase.com/) is an open-source dashboard software. It was deployed on the [EC instance](hardware.md) as a docker image, following [these instructions](https://www.metabase.com/start/oss/). 

### Docker Compose Configuration

The Metabase setup is configured using Docker Compose in the `connect-monitor/metabase` directory. The configuration consists of:

1. **Metabase Application Container**:
   - Image: `metabase/metabase`
   - Container name: `metabase`
   - Ports: 3000:3000 (exposed to the network)
   - Connects to PostgreSQL for its internal data storage
   - Mounts the SQLite databases as read-only volumes
   - Connected to a dedicated bridge network

2. **PostgreSQL Container for Metabase**:
   - Image: `postgres:15`
   - Container name: `metabase-db`
   - Stores Metabase's internal configuration, user accounts, saved queries, and dashboards
   - Data persisted in `postgres_metabase_config_and_user` directory
   - Connected to the same bridge network

3. **Network Configuration**:
   - Custom bridge network named `metabase-network`
   - Ensures proper hostname resolution between containers

The docker-compose.yml file can be found in the `connect-monitor/metabase` directory.

### Running Metabase

To start the Metabase services:

```bash
# Navigate to the metabase directory
cd metabase

# Start the Docker Compose services
sudo docker-compose up -d
```

The dashboard will be available at http://localhost:3000 or at the configured external URL.

### Data Flow

1. The EFMO backend workflows (configured in `data_workflows.py`) generate SQLite databases with processed funding data
2. These databases are stored in the `metabase/data` directory
3. The Metabase container mounts this directory as a read-only volume
4. Metabase administrators can connect to these SQLite databases through the Metabase interface
5. Users can then create visualizations, reports, and dashboards based on the data

It is running in container ```ca9d09406ea8``` as evident from the output of ```sudo docker ps```:

```
CONTAINER ID   IMAGE               COMMAND                  CREATED       STATUS       PORTS                                       NAMES
ca9d09406ea8   metabase/metabase   "/app/run_metabase.sh"   2 weeks ago   Up 6 hours   0.0.0.0:3000->3000/tcp, :::3000->3000/tcp   metabase
```

The container has been equipped with an additional virtual drive for mounting ```/var/lib/docker/volumes/cnect-monitor-data/_data/```. This is where the [crontab](hardware.md) copies the databases generated by the [EFMO workflows](efmo_workflows.md).


The container has also been configured to start after every reboot. 



## Admin Login

The [admin settings](http://quantum-monitor.cnect-srv4dev.s4dad.aws.cloud.tech.ec.europa.eu:3000/admin/settings/setup) can be used to, for example
- add and remove people and manage their permissions
- add databases

### Troubleshooting

If you encounter issues with the Metabase setup:

1. **Connection Errors**: If Metabase cannot connect to the PostgreSQL database:
   - Check container logs: `docker logs metabase`
   - Ensure both containers are running: `docker ps`
   - Verify network configuration in docker-compose.yml

2. **PostgreSQL Data Directory Issues**:
   - Ensure correct permissions: `sudo chown -R 999:999 ./postgres_metabase_config_and_user`
   - PostgreSQL runs as user 999 inside the container

3. **Clean Restart**:
   - Stop and remove all containers: `docker-compose down -v`
   - Remove PostgreSQL data directory: `sudo rm -rf ./postgres_metabase_config_and_user`
   - Start services again: `docker-compose up -d`

4. **Startup Time**:
   - Metabase may take 30-60 seconds to fully initialize on first startup
   - Check logs for completion before attempting to access the dashboard

5. **Windows-specific Docker Issues**:
   - If you see errors about "pipe/dockerDesktopLinuxEngine" or Docker connections:
     1. Verify Docker Desktop is running in your system tray
     2. If not, start Docker Desktop from the Start menu
     3. Wait for Docker to fully initialize (the whale icon stops animating)
     4. Verify Docker is running with `docker info` in PowerShell
     5. Try running `docker-compose up -d` again
   - On Windows, do not use `sudo` for Docker commands
